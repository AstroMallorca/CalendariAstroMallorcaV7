<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Messiers</title>

  <!-- Astronomy Engine local -->
  <script src="assets/js/astronomy.browser.min.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:rgba(0,0,0,.65);
      --border:rgba(0,0,0,.18);
      --card: rgba(0,0,0,0.03);
      --ok: rgba(0,0,0,0.08);
    }
    body.nocturn{
      --bg:#000000;
      --text:#ff2a2a;
      --muted:rgba(255,42,42,.75);
      --border:rgba(255,42,42,.35);
      --card: rgba(255,42,42,0.08);
      --ok: rgba(255,42,42,0.14);
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding:16px;
    }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    a{ color:inherit; text-decoration:none; }
    .muted{ color: var(--muted); }
    .controls label{ font-size:14px; }
    .controls input{
      width:80px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--border);
      background: transparent;
      color: inherit;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card{
      display:grid;
      grid-template-columns: 64px 1fr auto;
      gap:12px;
      align-items:center;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background: var(--card);
    }
    .thumb{
      width:64px;
      height:64px;
      border-radius:14px;
      object-fit:cover;
      border:1px solid var(--border);
      background: var(--ok);
    }
    .title{
      font-weight:800;
      font-size:16px;
      line-height:1.1;
      margin:0;
    }
    .sub{
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--muted);
    }
    .right{
      text-align:right;
      font-variant-numeric: tabular-nums;
      min-width: 120px;
    }
.tag{
  display:inline-block;
  margin-top:6px;
  padding:4px 8px;
  border-radius:10px;         /* ✅ rectangle arrodonit */
  border:1px solid var(--border);
  font-size:12px;
  color: var(--muted);
  max-width: 100%;
}
.tag{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

    }
    .warn{ opacity:.8; }
    .page-title{
  margin: 6px 0 4px;
  text-align:center;
}
.page-date{
  text-align:center;
  margin-bottom: 12px;
}

.title{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.sub{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

  </style>
</head>

<body>
  <div class="top">
    <a href="#" id="back">← Tornar</a>
  </div>

  <h1 style="margin: 6px 0 6px;">Objectes Messier</h1>
  <div class="muted" id="subtitle"></div>
  <div class="list" id="list"></div>

<script>
/* === Hereta mode nocturn (igual que sol.html / lluna.html) === */
try{
  const apply = () => {
    const isNocturn = localStorage.getItem("nocturn") === "1";
    document.body.classList.toggle("nocturn", isNocturn);
  };
  apply();
  window.addEventListener("storage", (e) => { if (e.key === "nocturn") apply(); });
}catch(e){}

/* === Helpers === */
function pad2(n){ return String(n).padStart(2,"0"); }
function fmtHHMM(d){
  if(!d) return "—";
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
  function fmtDur(min){
  const m = Math.max(0, Math.round(min || 0));
  const h = Math.floor(m/60);
  const mm = m % 60;
  return `${h}h ${pad2(mm)}'`;
}
function parseISODateLocal(iso){
  const [y,m,d] = (iso||"").split("-").map(Number);
  if(!y||!m||!d) return null;
  return new Date(y, m-1, d, 12, 0, 0); // migdia evita problemes de límit de dia
}
function startOfDayLocal(iso){
  const [y,m,d] = (iso||"").split("-").map(Number);
  if(!y||!m||!d) return null;
  return new Date(y, m-1, d, 0, 0, 0);
}
function endOfDayLocal(iso){
  const [y,m,d] = (iso||"").split("-").map(Number);
  if(!y||!m||!d) return null;
  return new Date(y, m-1, d, 23, 59, 59);
}
function minutesBetween(a,b){
  return Math.max(0, Math.round((b - a)/60000));
}
function lerpTime(t1, t2, frac){
  return new Date(t1.getTime() + frac*(t2.getTime() - t1.getTime()));
}

/* === Astronomia: alt d’un objecte fix (RA/Dec) === */
function altDegAt(date, obs, ra_h, dec_deg){
  const t = Astronomy.MakeTime(date);
  // Horizon(time, observer, ra, dec, refraction)
  const h = Astronomy.Horizon(t, obs, ra_h, dec_deg, "normal");
  // API habitual: h.altitude en graus
  return h.altitude;
}

/* Troba rise/set aproximats per un llindar d’altura minAlt (graus)
   escanejant tot el dia amb pas stepMin. */
function approxRiseSetForDay(iso, obs, ra_h, dec_deg, minAlt, stepMin){
  const t0 = startOfDayLocal(iso);
  const t1 = endOfDayLocal(iso);
  if(!t0 || !t1) return {rise:null, set:null, state:"error"};

  const stepMs = stepMin * 60000;
  let prevT = t0;
  let prevA = altDegAt(prevT, obs, ra_h, dec_deg);

  let everUp = prevA >= minAlt;
  let everDown = prevA < minAlt;

  let rise = null, set = null;

  for(let t = new Date(prevT.getTime() + stepMs); t <= t1; t = new Date(t.getTime() + stepMs)){
    const a = altDegAt(t, obs, ra_h, dec_deg);
    everUp = everUp || (a >= minAlt);
    everDown = everDown || (a < minAlt);

    // creuament pujant
    if(!rise && prevA < minAlt && a >= minAlt){
      const frac = (minAlt - prevA) / (a - prevA);
      rise = lerpTime(prevT, t, frac);
    }
    // creuament baixant
    if(!set && prevA >= minAlt && a < minAlt){
      const frac = (minAlt - prevA) / (a - prevA);
      set = lerpTime(prevT, t, frac);
    }

    prevT = t;
    prevA = a;
  }

  if(!everUp) return {rise:null, set:null, state:"never"};
  if(!everDown) return {rise:null, set:null, state:"circumpolar"}; // sempre per damunt
  return {rise, set, state:"normal"};
}

/* Calcula minuts visibles dins un interval [a,b] */
function visibleMinutesInWindow(obs, ra_h, dec_deg, minAlt, stepMin, winA, winB){
  const stepMs = stepMin * 60000;
  let vis = 0;

  // també guardam primera i darrera vegada visible dins la finestra
  let first = null, last = null;

  for(let t = new Date(winA); t <= winB; t = new Date(t.getTime() + stepMs)){
    const alt = altDegAt(t, obs, ra_h, dec_deg);
    if(alt >= minAlt){
      vis += stepMin;
      if(!first) first = new Date(t);
      last = new Date(t);
    }
  }
  return {visMin: vis, first, last};
}

async function main(){
  const p = new URLSearchParams(location.search);
  const iso = p.get("date") || "";
  const lat = Number(p.get("lat"));
  const lon = Number(p.get("lon"));
  const elev = Number(p.get("elev") || 0);

  const dateMid = parseISODateLocal(iso);
  const obs = new Astronomy.Observer(lat, lon, Number.isFinite(elev)? elev : 0);

  document.getElementById("meta").textContent = iso;

  // Botó tornar
  document.getElementById("back").addEventListener("click", (e) => {
    e.preventDefault();
    window.history.back();
  });

  // Carrega catàleg
  const catalog = await fetch("data/messier_catalog.json").then(r => r.json());

  // Controls
  const computeAndRender = () => {
  const minAlt = 0;     // ✅ predeterminat a 0º
  const stepMin = 5;    // ✅ pas fix


// Sortida i posta de Sol (del mateix dia)
let sunrise = null;
let sunset  = null;
try{
  const dayStart = startOfDayLocal(iso);
  const tStart = Astronomy.MakeTime(dayStart);

  const r = Astronomy.SearchRiseSet(Astronomy.Body.Sun, obs, +1, tStart, 1, 0);
  sunrise = r ? r.date : null;

  const s = Astronomy.SearchRiseSet(Astronomy.Body.Sun, obs, -1, tStart, 1, 0);
  sunset = s ? s.date : null;
}catch(e){
  sunrise = null;
  sunset  = null;
}

// Dues finestres: 00:01→sortida i posta→23:59
const dayStart = startOfDayLocal(iso);
const dayEnd   = endOfDayLocal(iso);

const winPreA  = new Date(dayStart.getTime() + 60*1000); // 00:01
const winPreB  = sunrise ? sunrise : winPreA;

const winPostA = sunset ? sunset : dayStart;
const winPostB = dayEnd;

const enriched = catalog.map(obj => {
  const ra = Number(obj.ra_h);
  const dec = Number(obj.dec_deg);

  // ✅ si falten dades, no petis: posa'l al final
  if(!Number.isFinite(ra) || !Number.isFinite(dec)){
    return {
      ...obj,
      riseApprox: null,
      setApprox: null,
      state: "nodata",
      visEveningMin: -1,   // perquè quedi al final
      firstEvening: null,
      lastEvening: null,
      sunset
    };
  }

  const dayRS = approxRiseSetForDay(iso, obs, ra, dec, minAlt, stepMin);
const evPre  = visibleMinutesInWindow(obs, ra, dec, minAlt, stepMin, winPreA,  winPreB);
const evPost = visibleMinutesInWindow(obs, ra, dec, minAlt, stepMin, winPostA, winPostB);

return {
  ...obj,
  riseApprox: dayRS.rise,
  setApprox: dayRS.set,
  state: dayRS.state,

  visPreMin: evPre.visMin,
  visPostMin: evPost.visMin,
  visEveningMin: evPre.visMin + evPost.visMin, // TOTAL

  sunrise,
  sunset
};
});


    // Ordena: més minuts visibles el vespre primer
    enriched.sort((a,b) => (b.visEveningMin - a.visEveningMin) || (String(a.id).localeCompare(String(b.id))));

    // Render
    const list = document.getElementById("list");
    list.innerHTML = "";

    for(const o of enriched){
      const card = document.createElement("div");
      card.className = "card";

      const img = document.createElement("img");
      img.className = "thumb";
      img.loading = "lazy";
      const common = (o.desc || "").trim();
      img.alt = common ? `${o.id} ${common}` : `${o.id}`;
      img.src = o.img || "";
      img.onerror = () => { img.style.display = "none"; };

      const mid = document.createElement("div");
      const h = document.createElement("p");
      h.className = "title";
      h.textContent = common ? `${o.id} · ${common}` : `${o.id}`;
      const sub = document.createElement("p");
      sub.className = "sub";
      sub.textContent = o.type || "";

      const tag = document.createElement("div");
      tag.className = "tag";
      const total = o.visEveningMin || 0;
const pre   = o.visPreMin || 0;
const post  = o.visPostMin || 0;

const visTxt = total > 0
  ? `${fmtDur(total)} visibles el vespre (${fmtDur(pre)} abans de la sortida · ${fmtDur(post)} des de la posta)`
  : "No visible el vespre";

tag.textContent = `${visTxt}${Number.isFinite(o.mag) ? ` · mag ${o.mag}` : ""}`;


      mid.appendChild(h);
      mid.appendChild(sub);
      mid.appendChild(tag);

      const right = document.createElement("div");
      right.className = "right";

      const rs1 = document.createElement("div");
      rs1.innerHTML = `<span class="muted">↑</span> ${fmtHHMM(o.riseApprox)}`;
      const rs2 = document.createElement("div");
      rs2.innerHTML = `<span class="muted">↓</span> ${fmtHHMM(o.setApprox)}`;

      const rs3 = document.createElement("div");
      rs3.className = "muted";
      rs3.style.fontSize = "12px";
      if(o.state === "nodata"){
  rs3.textContent = "Sense coordenades (catàleg incomplet)";
  rs3.classList.add("warn");
} else if(o.state === "circumpolar"){
  rs3.textContent = "Circumpolar";
} else if(o.state === "never"){
  rs3.textContent = "No puja per damunt del llindar avui";
  rs3.classList.add("warn");
} else {
  rs3.textContent = o.sunset ? `Posta de Sol: ${fmtHHMM(o.sunset)}` : "";
}


      right.appendChild(rs1);
      right.appendChild(rs2);
      right.appendChild(rs3);

      card.appendChild(img);
      card.appendChild(mid);
      card.appendChild(right);

      list.appendChild(card);
    }
  };

  computeAndRender();
}

main().catch(err => {
  const list = document.getElementById("list");
  list.innerHTML = `<p class="muted">Error carregant dades: ${String(err)}</p>`;
});
</script>
</body>
</html>
