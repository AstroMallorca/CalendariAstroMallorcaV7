<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lluna</title>
  <link rel="icon" href="assets/icons/astromallorca.png">

  <style>
:root{
  /* DIA (per defecte) */
  --bg:#ffffff;
  --text:#111111;
  --muted:rgba(0,0,0,.65);
  --border:rgba(0,0,0,.18);
  --card: rgba(0,0,0,0.03);

  --perigeu:#ffd400;
  --apogeu:#19d6ff;
}

/* NOCTURN (heretat de l'app: body.nocturn) */
body.nocturn{
  --bg:#000000;
  --text:#ff2a2a;
  --muted:rgba(255,42,42,.75);
  --border:rgba(255,42,42,.35);
  --card: rgba(255,42,42,0.06);

  --perigeu:#ffd84d;
  --apogeu:#4fe3ff;
}

body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
}

a{ color: var(--text); text-decoration:none; opacity:.9; }
a:active{ opacity:1; }

.wrap{ max-width:520px; margin:0 auto; }

.topbar{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:12px;
}

.err{
  margin-top:16px;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  font-size:14px;
  background: var(--card);
  display:none;
}

/* Capçalera */
.header{ margin-top: 6px; }
.header h1{
  margin: 10px 0 6px;
  font-size: 40px;
  line-height: 1.05;
  letter-spacing: -0.5px;
  text-align: center;
}

.sub{
  text-align:center;
  margin-top: 4px;
}
.sub .date{
  color:var(--muted);
  font-size: 20px;
  margin: 2px 0;
}
.sub .age{
  color:var(--muted);
  font-size: 20px;
  margin: 2px 0 0;
}

/* LLUNA */
.moonbox{
  display:flex;
  justify-content:center;
  margin: 12px 0 6px;
}
.moonbox svg{
  width: 200px;
  height: 200px;
  max-width: 60vw;
  max-height: 60vw;
  overflow: visible;
}

/* Llegenda */
.legend{
  text-align:center;
  color:var(--muted);
  font-size: 16px;
  margin: 6px 0 10px;
  line-height: 1.2;
}

/* KPI 2 columnes */
.kpiGrid{
  width: 100%;
  margin: 14px auto 8px;
  display: grid;
  grid-template-columns: minmax(170px, 1fr) auto;
  gap: 6px 14px;
  max-width: 390px;
  font-size: 21px;
}
.kpiGrid .k{
  color:var(--muted);
  white-space: nowrap;
}
.kpiGrid .v{
  font-weight: 800;
  text-align: right;
  font-variant-numeric: tabular-nums;
  white-space: nowrap;
}

.subphase{
  text-align:center;
  color:var(--muted);
  font-size: 18px;
  margin: 0 0 6px;
}

/* ===== Secció gràfica ===== */
.chartWrap{
  margin: 18px auto 0;
  max-width: 520px;
}
.chartTitle{
  text-align:center;
  color:var(--muted);
  font-size: 18px;
  margin: 0 0 6px;
}
.chartBox{
  width: 100%;
  border-radius: 14px;
  padding: 10px 6px 4px;
}
.chartBox svg{
  width: 100%;
  height: 150px;
  display:block;
}

/* ===== Resum inferior ===== */
.stats{
  margin: 12px auto 0;
  max-width: 520px;
  display:grid;
  grid-template-columns: minmax(260px, 1fr) auto;
  gap: 6px 16px;
  font-size: 26px;
}
.stats .k{
  color:var(--text);
  white-space: nowrap;
}
.stats .v{
  font-weight: 800;
  text-align:right;
  font-variant-numeric: tabular-nums;
  white-space: nowrap;
}

#back{ color: var(--text); opacity: .9; }

@media (max-width: 360px){
  .header h1{ font-size: 34px; }
  .kpiGrid{ font-size: 19px; grid-template-columns: minmax(155px,1fr) auto; }
  .stats{ font-size: 22px; grid-template-columns: minmax(240px,1fr) auto; }
}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <a href="#" id="back">← Tornar</a>
    </div>

    <div class="header">
      <h1 id="title">—</h1>
      <div class="subphase" id="subphase"></div>
    </div>

    <div class="sub">
      <div class="date">Data: <span id="d"></span></div>
      <div class="age" id="age">Edat de la lluna: —</div>
    </div>

    <div class="moonbox" id="moonbox"></div>

    <div class="legend" id="legend">
      groc=perigeu<br>blau=apogeu
    </div>

    <div class="kpiGrid" id="kpiGrid">
      <div class="k">Il·luminació:</div><div class="v" id="kIll">—</div>
      <div class="k">Fase:</div><div class="v" id="kPhaseDeg">—</div>
      <div class="k">Mida aparent:</div><div class="v" id="kSize">—</div>
      <div class="k">Distància:</div><div class="v" id="kDist">—</div>
    </div>

    <!-- ===== Gràfica ===== -->
    <div class="chartWrap" id="chartWrap" style="display:none;">
      <div class="chartTitle" id="chartTitle">Altura max: —</div>
      <div class="chartBox" id="chartBox"></div>
    </div>

    <!-- ===== Resum inferior ===== -->
    <div class="stats" id="stats" style="display:none;">
      <div class="k">Temps total damunt l’horitzó:</div><div class="v" id="sAbove">—</div>
      <div class="k">Temps total de nit amb lluna:</div><div class="v" id="sNightMoon">—</div>
      <div class="k">Temps total de nit sense lluna:</div><div class="v" id="sNightNoMoon">—</div>
      <div class="k">Inclinació orbital:</div><div class="v" id="sIncl">—</div>
    </div>

    <div class="err" id="err"></div>
  </div>

  <!-- astronomy-engine (local) -->
  <script src="assets/js/astronomy.browser.min.js"></script>

  <script>
    const p = new URLSearchParams(location.search);
    const dateStr = p.get("date"); // "YYYY-MM-DD"
    document.getElementById("d").textContent = dateStr || "";

    document.getElementById("back").addEventListener("click", (e) => {
      e.preventDefault();
      window.history.back();
    });

    // ======= Localització =======
    function numParam(name, fallback){
      const v = p.get(name);
      const x = (v === null) ? NaN : Number(v);
      return Number.isFinite(x) ? x : fallback;
    }

    // Palma per defecte si no ve res
    const LAT  = numParam("lat", 39.5696);
    const LON  = numParam("lon", 2.6502);
    const ELEV = numParam("elev", 0);

    function getObserver(){
      return new Astronomy.Observer(LAT, LON, ELEV);
    }

    function parseISODateLocal(iso){
      if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return new Date();
      const [y,m,d] = iso.split("-").map(Number);
      return new Date(y, m-1, d, 12, 0, 0); // migdia local
    }

    function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
    function deg2rad(d){ return d * Math.PI / 180; }

    function fmtPct(x, decimals = 2){
      if (!Number.isFinite(x)) return "—";
      return `${x.toFixed(decimals)}%`;
    }

    function fmtTimeHM(d){
      return new Intl.DateTimeFormat("ca-ES", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      }).format(d);
    }

    function fmtDurationHM(ms){
      if (!Number.isFinite(ms) || ms < 0) return "—";
      const totalMin = Math.round(ms / 60000);
      const h = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      return `${h}h ${m}′`;
    }

    function inSameLocalDay(d, day){
      const a0 = new Date(day); a0.setHours(0,0,0,0);
      const a1 = new Date(day); a1.setHours(23,59,59,999);
      return d >= a0 && d <= a1;
    }

    // ======= FASE EXACTA =======
    function phaseExactEventForDay(day){
      const t0 = Astronomy.MakeTime(day);
      const targets = [
        { angle: 0,   name: "Lluna nova" },
        { angle: 90,  name: "Quart creixent" },
        { angle: 180, name: "Lluna plena" },
        { angle: 270, name: "Quart minvant" },
      ];

      for (const it of targets){
        const fwd  = Astronomy.SearchMoonPhase(it.angle, t0,  3);
        const back = Astronomy.SearchMoonPhase(it.angle, t0, -3);

        if (fwd  && inSameLocalDay(fwd.date,  day)) return { name: it.name, date: fwd.date  };
        if (back && inSameLocalDay(back.date, day)) return { name: it.name, date: back.date };
      }
      return null;
    }

    function phaseLabelForDay(phaseDeg, illum, day){
      const exactEv = phaseExactEventForDay(day);
      if (exactEv) return exactEv.name;

      const d = ((phaseDeg % 360) + 360) % 360;
      if (d > 0 && d < 180){
        return (illum < 0.5) ? "Crescent creixent" : "Gibosa creixent";
      } else {
        return (illum < 0.5) ? "Crescent minvant" : "Gibosa minvant";
      }
    }

    function moonAgeDays(day){
      const t = Astronomy.MakeTime(day);
      const prevNew = Astronomy.SearchMoonPhase(0, t, -35);
      if (!prevNew) return null;
      const ms = day.getTime() - prevNew.date.getTime();
      return ms / (1000 * 60 * 60 * 24);
    }

    function titleCaseCatalan(s){
      s = (s || "").trim();
      if (!s) return s;
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    // ======= DISTÀNCIA / APSIS / SUPERLLUNA =======
    function moonDistanceKmAt(date){
      const t = Astronomy.MakeTime(date);
      const v = Astronomy.GeoVector(Astronomy.Body.Moon, t, true);
      const rAU = Math.sqrt(v.x*v.x + v.y*v.y + v.z*v.z);
      const AU_KM = (typeof Astronomy.AU_KM === "number") ? Astronomy.AU_KM : 149597870.7;
      return rAU * AU_KM;
    }

    function apsisTagForDay(day, spanDays = 2, stepHours = 1){
      const start = new Date(day); start.setHours(0,0,0,0);
      const end   = new Date(day); end.setHours(23,59,59,999);

      const center = new Date(day); center.setHours(12,0,0,0);
      const t0 = new Date(center.getTime() - spanDays*24*3600*1000);
      const t1 = new Date(center.getTime() + spanDays*24*3600*1000);

      let minD = Infinity, minT = null;
      let maxD = -Infinity, maxT = null;

      for (let tt = new Date(t0); tt <= t1; tt = new Date(tt.getTime() + stepHours*3600*1000)){
        const dkm = moonDistanceKmAt(tt);
        if (dkm < minD){ minD = dkm; minT = new Date(tt); }
        if (dkm > maxD){ maxD = dkm; maxT = new Date(tt); }
      }

      if (minT && minT >= start && minT <= end) return { tag: "perigeu", time: minT, distKm: minD };
      if (maxT && maxT >= start && maxT <= end) return { tag: "apogeu",  time: maxT, distKm: maxD };
      return null;
    }

    function isSupermoon(fullMoonDate){
      const fullKm = moonDistanceKmAt(fullMoonDate);

      const center = new Date(fullMoonDate);
      const t0 = new Date(center.getTime() - 7*24*3600*1000);
      const t1 = new Date(center.getTime() + 7*24*3600*1000);

      let minD = Infinity, minT = null;
      for (let tt = new Date(t0); tt <= t1; tt = new Date(tt.getTime() + 2*3600*1000)){
        const dkm = moonDistanceKmAt(tt);
        if (dkm < minD){ minD = dkm; minT = new Date(tt); }
      }
      if (!minT) return false;

      const dtHours = Math.abs(fullMoonDate.getTime() - minT.getTime()) / (1000*3600);
      return (dtHours <= 24) && (fullKm <= 360000);
    }

    // ======= ALTURA (per mostreig) =======
    function bodyAltitudeDeg(body, observer, date){
      const t = Astronomy.MakeTime(date);
      const eq = Astronomy.Equator(body, t, observer, true, true);
      if (!eq || !Number.isFinite(eq.ra) || !Number.isFinite(eq.dec)) return null;

      const hor = Astronomy.Horizon(t, observer, eq.ra, eq.dec, true);
      if (!hor || !Number.isFinite(hor.altitude)) return null;

      return hor.altitude;
    }

    function maxAltitudeBetween(body, observer, tStartDate, tEndDate, stepMinutes = 5){
      if (!tStartDate || !tEndDate) return null;
      const t0 = tStartDate.getTime();
      const t1 = tEndDate.getTime();
      if (!(t1 > t0)) return null;

      let bestAlt = -1e9;
      let bestT = null;

      const stepMs = stepMinutes * 60 * 1000;

      for (let ms = t0; ms <= t1; ms += stepMs){
        const d = new Date(ms);
        const alt = bodyAltitudeDeg(body, observer, d);
        if (Number.isFinite(alt) && alt > bestAlt){
          bestAlt = alt;
          bestT = d;
        }
      }
      if (!bestT) return null;
      return { time: bestT, altDeg: bestAlt };
    }

    function overlapMs(a0, a1, b0, b1){
      const s = Math.max(a0.getTime(), b0.getTime());
      const e = Math.min(a1.getTime(), b1.getTime());
      return Math.max(0, e - s);
    }

    // ======= Gràfica minimalista (SVG) =======
    function renderArcChart({ rise, transit, set }){
      const W = 520, H = 150;
      const padX = 26;
      const baseY = 88;

      if (!rise || !set || !transit) return "";

      const t0 = rise.getTime();
      const t1 = set.getTime();
      const tc = transit.getTime();
      if (!(t1 > t0)) return "";

      const x = (t) => padX + ( (t - t0) / (t1 - t0) ) * (W - 2*padX);

      const xR = x(t0), xT = x(tc), xS = x(t1);
      const peakY = 24;
      const d = `M ${xR} ${baseY} Q ${xT} ${peakY} ${xS} ${baseY}`;

      const strokeArc = (document.body.classList.contains("nocturn")) ? "var(--text)" : "var(--text)";
      const strokeAxis = "var(--text)";

      return `
<svg viewBox="0 0 ${W} ${H}" role="img" aria-label="Trajectòria de la Lluna">
  <line x1="${padX}" y1="${baseY}" x2="${W-padX}" y2="${baseY}" stroke="${strokeAxis}" stroke-width="3" />
  <path d="${d}" fill="none" stroke="${strokeArc}" stroke-width="6" stroke-linecap="round" />
  <line x1="${xR}" y1="${baseY-55}" x2="${xR}" y2="${baseY+22}" stroke="${strokeAxis}" stroke-width="2" opacity="0.7"/>
  <line x1="${xT}" y1="${baseY-65}" x2="${xT}" y2="${baseY+22}" stroke="${strokeAxis}" stroke-width="2" opacity="0.7"/>
  <line x1="${xS}" y1="${baseY-55}" x2="${xS}" y2="${baseY+22}" stroke="${strokeAxis}" stroke-width="2" opacity="0.7"/>

  <text x="${xR}" y="${H-16}" text-anchor="middle" font-size="20" fill="${strokeAxis}">${fmtTimeHM(rise)}</text>
  <text x="${xT}" y="${H-16}" text-anchor="middle" font-size="20" fill="${strokeAxis}">${fmtTimeHM(transit)}</text>
  <text x="${xS}" y="${H-16}" text-anchor="middle" font-size="20" fill="${strokeAxis}">${fmtTimeHM(set)}</text>
</svg>`;
    }

    // ======= SVG LLUNA (fase + mida) =======
    function renderMoonSVG(opts){
      const {
        R_perigeu = 108,
        R_apogeu  = 96,
        R_now     = 102,
        illum = 0.5,
        waxing = true
      } = opts;

      const cx = 120, cy = 120;
      const R = R_now;

      const cosPhi = (2 * clamp(illum, 0, 1)) - 1;
      let rx = Math.abs(cosPhi) * R;
      if (rx < 0.001) rx = 0.001;

      const isGibbous = illum > 0.5;
      const sweepLimb = waxing ? 1 : 0;

      let sweepTerm;
      if (!isGibbous) sweepTerm = waxing ? 0 : 1;
      else            sweepTerm = waxing ? 1 : 0;

      const almostNew  = illum < 0.01;
      const almostFull = illum > 0.99;

      const pathLit = `
        M ${cx} ${cy - R}
        A ${R} ${R} 0 0 ${sweepLimb} ${cx} ${cy + R}
        A ${rx} ${R} 0 0 ${sweepTerm} ${cx} ${cy - R}
        Z
      `;

      const IMG = "assets/moon/plena.png";

      return `
<svg viewBox="0 0 240 240" aria-label="Fase lunar" role="img">
  <defs>
    <clipPath id="clipDisc"><circle cx="${cx}" cy="${cy}" r="${R}"></circle></clipPath>

    <mask id="maskShadow">
      <rect x="0" y="0" width="240" height="240" fill="black"></rect>
      <circle cx="${cx}" cy="${cy}" r="${R}" fill="white"></circle>
      ${almostNew ? "" : `<path d="${pathLit}" fill="black"></path>`}
    </mask>

    <mask id="maskLit">
      <rect x="0" y="0" width="240" height="240" fill="black"></rect>
      ${
        almostFull
          ? `<circle cx="${cx}" cy="${cy}" r="${R}" fill="white"></circle>`
          : (almostNew ? "" : `<path d="${pathLit}" fill="white"></path>`)
      }
    </mask>
  </defs>

  <circle cx="${cx}" cy="${cy}" r="${R_perigeu}" fill="none" stroke="var(--perigeu)" stroke-width="2.5"></circle>
  <circle cx="${cx}" cy="${cy}" r="${R_apogeu}"  fill="none" stroke="var(--apogeu)"  stroke-width="2.5"></circle>

  <g clip-path="url(#clipDisc)">
    <image href="${IMG}" x="${cx-R}" y="${cy-R}" width="${2*R}" height="${2*R}"
           preserveAspectRatio="xMidYMid slice" opacity="0.75"></image>
  </g>

  <g clip-path="url(#clipDisc)" mask="url(#maskLit)">
    <image href="${IMG}" x="${cx-R}" y="${cy-R}" width="${2*R}" height="${2*R}"
           preserveAspectRatio="xMidYMid slice" opacity="1"></image>
  </g>

  <g clip-path="url(#clipDisc)" mask="url(#maskShadow)">
    <rect x="${cx-R}" y="${cy-R}" width="${2*R}" height="${2*R}" fill="rgba(0,0,0,0.65)"></rect>
  </g>

  <circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="rgba(0,0,0,0.25)" stroke-width="1"></circle>
</svg>`;
    }

    (function main(){
      const errEl = document.getElementById("err");
      const box = document.getElementById("moonbox");

      try{
        if (typeof Astronomy === "undefined") throw new Error("Astronomy Engine no s'ha carregat.");

        const observer = getObserver();
        const day = parseISODateLocal(dateStr);
        const t = Astronomy.MakeTime(day);

        const phaseDeg = Astronomy.MoonPhase(t);
        const waxing = (phaseDeg >= 0 && phaseDeg < 180);

        const phaseAngle = (phaseDeg <= 180) ? phaseDeg : (360 - phaseDeg);
        const illum = (1 - Math.cos(deg2rad(phaseAngle))) / 2;

        const v = Astronomy.GeoVector(Astronomy.Body.Moon, t, true);
        const rAU = Math.sqrt(v.x*v.x + v.y*v.y + v.z*v.z);
        const AU_KM = (typeof Astronomy.AU_KM === "number") ? Astronomy.AU_KM : 149597870.7;
        const distKm = rAU * AU_KM;

        const R_MOON_KM = 1737.4;
        const angRad = 2 * Math.atan(R_MOON_KM / distKm);
        const angArcmin = (angRad * 180 / Math.PI) * 60;

        const APog = 29.4;
        const PErig = 33.5;
        const R_perigeu = 108;
        const R_apogeu  = 96;

        const u = clamp((angArcmin - APog) / (PErig - APog), 0, 1);
        const R_now = R_apogeu + u * (R_perigeu - R_apogeu);

        // TÍTOL + Superlluna
        const exactEv = phaseExactEventForDay(day);
        const label = phaseLabelForDay(phaseDeg, illum, day);

        let title = titleCaseCatalan(label);
        if (exactEv && exactEv.name === "Lluna plena" && isSupermoon(exactEv.date)){
          title += " · Superlluna";
        }
        document.getElementById("title").textContent = title;

        // Subtítol d'hora (només fase exacta)
        const sub = document.getElementById("subphase");
        if (sub){
          sub.textContent = exactEv ? `(${fmtTimeHM(exactEv.date)})` : "";
        }

        // KPI
        document.getElementById("kIll").textContent      = fmtPct(illum*100, 2);
        document.getElementById("kPhaseDeg").textContent = `${phaseDeg.toFixed(1)}°`;
        document.getElementById("kSize").textContent     = `${angArcmin.toFixed(1)}′`;

        const apsis = apsisTagForDay(day);
        const apsisTxt = apsis ? ` (${apsis.tag})` : "";
        document.getElementById("kDist").textContent =
          `${Math.round(distKm).toLocaleString("ca-ES")} km${apsisTxt}`;

        // Edat
        const age = moonAgeDays(day);
        document.getElementById("age").textContent = Number.isFinite(age)
          ? `Edat de la lluna: ${age.toFixed(1)} dies`
          : "Edat de la lluna: —";

        // SVG Lluna
        box.innerHTML = renderMoonSVG({ R_perigeu, R_apogeu, R_now, illum, waxing });

        // ======= Gràfica + resum inferior =======
        const chartWrap = document.getElementById("chartWrap");
        const statsEl   = document.getElementById("stats");

        try{
          const day0 = new Date(day); day0.setHours(0,0,0,0);

          // Cercam rise/set a partir de (dia - 12h) per agafar el cicle correctament
          const startSearch = new Date(day0.getTime() - 12*3600*1000);
          const riseEv = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, +1, Astronomy.MakeTime(startSearch), 3);
          let setEv    = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, -1, Astronomy.MakeTime(startSearch), 3);

          const rise = riseEv ? riseEv.date : null;
          let set    = setEv  ? setEv.date  : null;

          if (rise && set && set.getTime() <= rise.getTime()){
            const afterRise = new Date(rise.getTime() + 5*60*1000);
            const set2 = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, -1, Astronomy.MakeTime(afterRise), 3);
            set = set2 ? set2.date : set;
          }

          const max = (rise && set) ? maxAltitudeBetween(Astronomy.Body.Moon, observer, rise, set, 5) : null;

          if (rise && set && max && Number.isFinite(max.altDeg)){
            chartWrap.style.display = "";
            document.getElementById("chartTitle").textContent = `Altura max: ${Math.round(max.altDeg)}°`;
            document.getElementById("chartBox").innerHTML = renderArcChart({
              rise,
              transit: max.time,
              set
            });

            const aboveMs = Math.max(0, set.getTime() - rise.getTime());
            document.getElementById("sAbove").textContent = fmtDurationHM(aboveMs);

            // Nit: sunset(dia) -> sunrise(dia+1)
            const day1 = new Date(day0.getTime() + 24*3600*1000);
            const noon0 = new Date(day0); noon0.setHours(12,0,0,0);
            const noon1 = new Date(day1); noon1.setHours(12,0,0,0);

            const sunsetEv  = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, -1, Astronomy.MakeTime(noon0), 2);
            const sunriseEv = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, +1, Astronomy.MakeTime(noon1), 2);

            const sunset  = sunsetEv  ? sunsetEv.date  : null;
            const sunrise = sunriseEv ? sunriseEv.date : null;

            if (sunset && sunrise){
              const nightMs = Math.max(0, sunrise.getTime() - sunset.getTime());
              const withMoonMs = overlapMs(sunset, sunrise, rise, set);
              const noMoonMs = Math.max(0, nightMs - withMoonMs);

              document.getElementById("sNightMoon").textContent = fmtDurationHM(withMoonMs);
              document.getElementById("sNightNoMoon").textContent = fmtDurationHM(noMoonMs);
            }else{
              document.getElementById("sNightMoon").textContent = "—";
              document.getElementById("sNightNoMoon").textContent = "—";
            }

            document.getElementById("sIncl").textContent = "—";
            statsEl.style.display = "";
          }else{
            chartWrap.style.display = "none";
            statsEl.style.display = "none";
          }
        }catch(_e){
          chartWrap.style.display = "none";
          statsEl.style.display = "none";
        }

      }catch(e){
        console.error(e);
        errEl.style.display = "block";
        errEl.textContent = "Error: " + (e?.message || e);
      }
    })();

    // Hereta el mode nocturn de l'app (localStorage) i escolta canvis
    try{
      const apply = () => {
        const isNocturn = localStorage.getItem("nocturn") === "1";
        document.body.classList.toggle("nocturn", isNocturn);
      };
      apply();
      window.addEventListener("storage", (e) => {
        if (e.key === "nocturn") apply();
      });
    }catch(e){}
  </script>
</body>
</html>
